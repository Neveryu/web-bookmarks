<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>THREE 知识体系梳理 | web-bookmarks</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/web-bookmarks/favicon.ico">
    <link rel="manifest" href="/web-bookmarks/manifest.json">
    <link rel="apple-touch-icon" href="/web-bookmarks/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/web-bookmarks/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="前端工程师知识技能储备库">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/web-bookmarks/assets/css/0.styles.be43791e.css" as="style"><link rel="preload" href="/web-bookmarks/assets/js/app.043910a3.js" as="script"><link rel="preload" href="/web-bookmarks/assets/js/2.74e402c0.js" as="script"><link rel="preload" href="/web-bookmarks/assets/js/1.f201e22a.js" as="script"><link rel="preload" href="/web-bookmarks/assets/js/11.a8e47de5.js" as="script"><link rel="prefetch" href="/web-bookmarks/assets/js/10.354a13ae.js"><link rel="prefetch" href="/web-bookmarks/assets/js/100.231b51bb.js"><link rel="prefetch" href="/web-bookmarks/assets/js/101.f5498f86.js"><link rel="prefetch" href="/web-bookmarks/assets/js/102.c26db37d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/103.b0cc39a0.js"><link rel="prefetch" href="/web-bookmarks/assets/js/104.5a2cd4da.js"><link rel="prefetch" href="/web-bookmarks/assets/js/105.b9b69277.js"><link rel="prefetch" href="/web-bookmarks/assets/js/106.01f5594a.js"><link rel="prefetch" href="/web-bookmarks/assets/js/107.f605ce83.js"><link rel="prefetch" href="/web-bookmarks/assets/js/108.fa7e5a0c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/109.42264323.js"><link rel="prefetch" href="/web-bookmarks/assets/js/110.41c31db5.js"><link rel="prefetch" href="/web-bookmarks/assets/js/111.2dafc22f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/112.dad9ed14.js"><link rel="prefetch" href="/web-bookmarks/assets/js/113.c41ae3ee.js"><link rel="prefetch" href="/web-bookmarks/assets/js/114.fc7348e5.js"><link rel="prefetch" href="/web-bookmarks/assets/js/115.3d563ad4.js"><link rel="prefetch" href="/web-bookmarks/assets/js/116.9784c22f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/117.b67a9457.js"><link rel="prefetch" href="/web-bookmarks/assets/js/118.b7deb08c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/119.6f1f3b64.js"><link rel="prefetch" href="/web-bookmarks/assets/js/12.06e9bc8c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/120.d6707131.js"><link rel="prefetch" href="/web-bookmarks/assets/js/121.5ceabb8d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/122.441d2394.js"><link rel="prefetch" href="/web-bookmarks/assets/js/123.efece045.js"><link rel="prefetch" href="/web-bookmarks/assets/js/124.49659745.js"><link rel="prefetch" href="/web-bookmarks/assets/js/125.0a819290.js"><link rel="prefetch" href="/web-bookmarks/assets/js/126.5f88739e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/127.1b196dc3.js"><link rel="prefetch" href="/web-bookmarks/assets/js/128.6802358e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/129.5751c9a2.js"><link rel="prefetch" href="/web-bookmarks/assets/js/13.bc188b8d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/130.b01b7d74.js"><link rel="prefetch" href="/web-bookmarks/assets/js/131.a5f15a06.js"><link rel="prefetch" href="/web-bookmarks/assets/js/132.d815753b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/133.185f56bf.js"><link rel="prefetch" href="/web-bookmarks/assets/js/134.c3b852e0.js"><link rel="prefetch" href="/web-bookmarks/assets/js/135.0d853f1e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/136.25f20919.js"><link rel="prefetch" href="/web-bookmarks/assets/js/137.9be2d448.js"><link rel="prefetch" href="/web-bookmarks/assets/js/138.081afdec.js"><link rel="prefetch" href="/web-bookmarks/assets/js/139.2cccf885.js"><link rel="prefetch" href="/web-bookmarks/assets/js/14.c5247a30.js"><link rel="prefetch" href="/web-bookmarks/assets/js/140.5311f103.js"><link rel="prefetch" href="/web-bookmarks/assets/js/141.1529e261.js"><link rel="prefetch" href="/web-bookmarks/assets/js/142.13f2174c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/143.670e3891.js"><link rel="prefetch" href="/web-bookmarks/assets/js/144.17eba443.js"><link rel="prefetch" href="/web-bookmarks/assets/js/145.d1d6955f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/146.cbb5b245.js"><link rel="prefetch" href="/web-bookmarks/assets/js/147.7aef7fc1.js"><link rel="prefetch" href="/web-bookmarks/assets/js/148.f2005ee4.js"><link rel="prefetch" href="/web-bookmarks/assets/js/149.20d4aa3c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/15.b9a8a903.js"><link rel="prefetch" href="/web-bookmarks/assets/js/150.4aa464ee.js"><link rel="prefetch" href="/web-bookmarks/assets/js/151.428c8d49.js"><link rel="prefetch" href="/web-bookmarks/assets/js/152.8e1b17d7.js"><link rel="prefetch" href="/web-bookmarks/assets/js/153.51091464.js"><link rel="prefetch" href="/web-bookmarks/assets/js/154.281767d3.js"><link rel="prefetch" href="/web-bookmarks/assets/js/155.10b64bf7.js"><link rel="prefetch" href="/web-bookmarks/assets/js/156.c5447594.js"><link rel="prefetch" href="/web-bookmarks/assets/js/157.e2af1ed6.js"><link rel="prefetch" href="/web-bookmarks/assets/js/158.2d6ab937.js"><link rel="prefetch" href="/web-bookmarks/assets/js/159.ccf0689e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/16.7f863943.js"><link rel="prefetch" href="/web-bookmarks/assets/js/160.08428253.js"><link rel="prefetch" href="/web-bookmarks/assets/js/161.2c3b466e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/162.2014651f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/163.fdf191ce.js"><link rel="prefetch" href="/web-bookmarks/assets/js/164.aa1ad3d8.js"><link rel="prefetch" href="/web-bookmarks/assets/js/165.424c54d6.js"><link rel="prefetch" href="/web-bookmarks/assets/js/166.6e8de4a3.js"><link rel="prefetch" href="/web-bookmarks/assets/js/167.a32a2479.js"><link rel="prefetch" href="/web-bookmarks/assets/js/168.e97d4a60.js"><link rel="prefetch" href="/web-bookmarks/assets/js/169.9fff1328.js"><link rel="prefetch" href="/web-bookmarks/assets/js/17.355cc133.js"><link rel="prefetch" href="/web-bookmarks/assets/js/170.fd25af6a.js"><link rel="prefetch" href="/web-bookmarks/assets/js/171.aefc06ba.js"><link rel="prefetch" href="/web-bookmarks/assets/js/172.e6ecf8fb.js"><link rel="prefetch" href="/web-bookmarks/assets/js/173.6e4a9322.js"><link rel="prefetch" href="/web-bookmarks/assets/js/174.3b178aae.js"><link rel="prefetch" href="/web-bookmarks/assets/js/175.a83ec2ab.js"><link rel="prefetch" href="/web-bookmarks/assets/js/176.1dc51a14.js"><link rel="prefetch" href="/web-bookmarks/assets/js/177.a6388d19.js"><link rel="prefetch" href="/web-bookmarks/assets/js/178.f8077315.js"><link rel="prefetch" href="/web-bookmarks/assets/js/179.17dbc6fe.js"><link rel="prefetch" href="/web-bookmarks/assets/js/18.ae544204.js"><link rel="prefetch" href="/web-bookmarks/assets/js/180.8e626bdc.js"><link rel="prefetch" href="/web-bookmarks/assets/js/181.6b698508.js"><link rel="prefetch" href="/web-bookmarks/assets/js/182.97e86b0f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/183.9b3e1c13.js"><link rel="prefetch" href="/web-bookmarks/assets/js/184.b51e8e6b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/185.465bc4d8.js"><link rel="prefetch" href="/web-bookmarks/assets/js/186.6c59415b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/187.f5fc33e7.js"><link rel="prefetch" href="/web-bookmarks/assets/js/19.647e5f6d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/20.9717638d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/21.0cac5171.js"><link rel="prefetch" href="/web-bookmarks/assets/js/22.c70cc195.js"><link rel="prefetch" href="/web-bookmarks/assets/js/23.d9003184.js"><link rel="prefetch" href="/web-bookmarks/assets/js/24.211511f5.js"><link rel="prefetch" href="/web-bookmarks/assets/js/25.04e1b069.js"><link rel="prefetch" href="/web-bookmarks/assets/js/26.2d270406.js"><link rel="prefetch" href="/web-bookmarks/assets/js/27.e7533300.js"><link rel="prefetch" href="/web-bookmarks/assets/js/28.3aed94f9.js"><link rel="prefetch" href="/web-bookmarks/assets/js/29.92e273be.js"><link rel="prefetch" href="/web-bookmarks/assets/js/3.245bfa5f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/30.25d0a87b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/31.6faa7834.js"><link rel="prefetch" href="/web-bookmarks/assets/js/32.299ba881.js"><link rel="prefetch" href="/web-bookmarks/assets/js/33.41e708ec.js"><link rel="prefetch" href="/web-bookmarks/assets/js/34.43f2ea4c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/35.dba0c764.js"><link rel="prefetch" href="/web-bookmarks/assets/js/36.5890167a.js"><link rel="prefetch" href="/web-bookmarks/assets/js/37.9204a83c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/38.9c10d6c0.js"><link rel="prefetch" href="/web-bookmarks/assets/js/39.ee2d015e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/4.303619ef.js"><link rel="prefetch" href="/web-bookmarks/assets/js/40.12bc65b1.js"><link rel="prefetch" href="/web-bookmarks/assets/js/41.c692c85f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/42.d3c9563c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/43.75b7f0d0.js"><link rel="prefetch" href="/web-bookmarks/assets/js/44.4074bfab.js"><link rel="prefetch" href="/web-bookmarks/assets/js/45.47af80c6.js"><link rel="prefetch" href="/web-bookmarks/assets/js/46.45407a55.js"><link rel="prefetch" href="/web-bookmarks/assets/js/47.4d92bddc.js"><link rel="prefetch" href="/web-bookmarks/assets/js/48.4623def6.js"><link rel="prefetch" href="/web-bookmarks/assets/js/49.ee8d8a3f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/5.c3b159b5.js"><link rel="prefetch" href="/web-bookmarks/assets/js/50.9fd61421.js"><link rel="prefetch" href="/web-bookmarks/assets/js/51.29cd7135.js"><link rel="prefetch" href="/web-bookmarks/assets/js/52.f1fb6ea9.js"><link rel="prefetch" href="/web-bookmarks/assets/js/53.0e27457c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/54.8bfb07d1.js"><link rel="prefetch" href="/web-bookmarks/assets/js/55.9bc14cfd.js"><link rel="prefetch" href="/web-bookmarks/assets/js/56.342a8ea7.js"><link rel="prefetch" href="/web-bookmarks/assets/js/57.412d5585.js"><link rel="prefetch" href="/web-bookmarks/assets/js/58.d329c30b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/59.109b57de.js"><link rel="prefetch" href="/web-bookmarks/assets/js/6.97f1d865.js"><link rel="prefetch" href="/web-bookmarks/assets/js/60.613d638c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/61.a17f4122.js"><link rel="prefetch" href="/web-bookmarks/assets/js/62.21fa7b30.js"><link rel="prefetch" href="/web-bookmarks/assets/js/63.23ef9c2a.js"><link rel="prefetch" href="/web-bookmarks/assets/js/64.054f05b7.js"><link rel="prefetch" href="/web-bookmarks/assets/js/65.daa9cb0e.js"><link rel="prefetch" href="/web-bookmarks/assets/js/66.6ad3eba9.js"><link rel="prefetch" href="/web-bookmarks/assets/js/67.2b5864a8.js"><link rel="prefetch" href="/web-bookmarks/assets/js/68.4fa92fee.js"><link rel="prefetch" href="/web-bookmarks/assets/js/69.01d0267f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/7.292d0198.js"><link rel="prefetch" href="/web-bookmarks/assets/js/70.aaa34d7d.js"><link rel="prefetch" href="/web-bookmarks/assets/js/71.7a2d0ad2.js"><link rel="prefetch" href="/web-bookmarks/assets/js/72.3fa46e21.js"><link rel="prefetch" href="/web-bookmarks/assets/js/73.2522884b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/74.1fb3f457.js"><link rel="prefetch" href="/web-bookmarks/assets/js/75.ea873445.js"><link rel="prefetch" href="/web-bookmarks/assets/js/76.a46f6d49.js"><link rel="prefetch" href="/web-bookmarks/assets/js/77.d44b7435.js"><link rel="prefetch" href="/web-bookmarks/assets/js/78.92b74921.js"><link rel="prefetch" href="/web-bookmarks/assets/js/79.1f0edaf4.js"><link rel="prefetch" href="/web-bookmarks/assets/js/80.4f6f29fb.js"><link rel="prefetch" href="/web-bookmarks/assets/js/81.a0b9588f.js"><link rel="prefetch" href="/web-bookmarks/assets/js/82.6bd2a0e8.js"><link rel="prefetch" href="/web-bookmarks/assets/js/83.eb553514.js"><link rel="prefetch" href="/web-bookmarks/assets/js/84.577b332b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/85.f5deacda.js"><link rel="prefetch" href="/web-bookmarks/assets/js/86.f9fb89ab.js"><link rel="prefetch" href="/web-bookmarks/assets/js/87.12490f43.js"><link rel="prefetch" href="/web-bookmarks/assets/js/88.4a7671ad.js"><link rel="prefetch" href="/web-bookmarks/assets/js/89.ab4a7855.js"><link rel="prefetch" href="/web-bookmarks/assets/js/90.a761cf6a.js"><link rel="prefetch" href="/web-bookmarks/assets/js/91.3a490844.js"><link rel="prefetch" href="/web-bookmarks/assets/js/92.d228211b.js"><link rel="prefetch" href="/web-bookmarks/assets/js/93.de7b4637.js"><link rel="prefetch" href="/web-bookmarks/assets/js/94.3c654b79.js"><link rel="prefetch" href="/web-bookmarks/assets/js/95.654881bc.js"><link rel="prefetch" href="/web-bookmarks/assets/js/96.7525d03c.js"><link rel="prefetch" href="/web-bookmarks/assets/js/97.104767f6.js"><link rel="prefetch" href="/web-bookmarks/assets/js/98.b44ebfd8.js"><link rel="prefetch" href="/web-bookmarks/assets/js/99.b25ce506.js"><link rel="prefetch" href="/web-bookmarks/assets/js/vendors~docsearch.56a0f16e.js">
    <link rel="stylesheet" href="/web-bookmarks/assets/css/0.styles.be43791e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-bookmarks/" class="home-link router-link-active"><img src="/web-bookmarks/cute-spear-monster.jpg" alt="web-bookmarks" class="logo"> <span class="site-name can-hide">web-bookmarks</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/html/a1.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/css/a1.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/javascript/a1.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/color/a1.html" class="nav-link">
  Color
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/regx/a1.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/word-interpretation/a1.html" class="nav-link">
  名词释义
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><span class="title">收藏</span> <span class="arrow down"></span></button> <button type="button" aria-label="收藏" class="mobile-dropdown-title"><span class="title">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/tool/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/site/" class="nav-link">
  网站
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/other/" class="nav-link">
  其他综合
</a></li></ul></div></div><div class="nav-item"><a href="/web-bookmarks/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/web-bookmarks/rtsp2web/" class="nav-link">
  rtsp2web
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="综合" class="dropdown-title"><span class="title">综合</span> <span class="arrow down"></span></button> <button type="button" aria-label="综合" class="mobile-dropdown-title"><span class="title">综合</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/tech/" class="nav-link">
  技术
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/docs/" class="nav-link">
  文档
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/notes/" class="nav-link router-link-active">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/health/" class="nav-link">
  健康
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文字" class="dropdown-title"><span class="title">文字</span> <span class="arrow down"></span></button> <button type="button" aria-label="文字" class="mobile-dropdown-title"><span class="title">文字</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/book/" class="nav-link">
  书
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/foreign/" class="nav-link">
  外文
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/cognition/" class="nav-link">
  认知
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/music/" class="nav-link">
  音乐
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/video/" class="nav-link">
  视频
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/gard/" class="nav-link">
  圈子
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/kobe/" class="nav-link">
  KOBE
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/s/" class="nav-link">
  大S
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/culture/" class="nav-link">
  文化
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/another/" class="nav-link">
  其它
</a></li></ul></div></div> <a href="https://github.com/Neveryu/web-bookmarks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/html/a1.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/css/a1.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/javascript/a1.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/color/a1.html" class="nav-link">
  Color
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/regx/a1.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/base/word-interpretation/a1.html" class="nav-link">
  名词释义
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><span class="title">收藏</span> <span class="arrow down"></span></button> <button type="button" aria-label="收藏" class="mobile-dropdown-title"><span class="title">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/tool/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/site/" class="nav-link">
  网站
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/favorite/other/" class="nav-link">
  其他综合
</a></li></ul></div></div><div class="nav-item"><a href="/web-bookmarks/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/web-bookmarks/rtsp2web/" class="nav-link">
  rtsp2web
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="综合" class="dropdown-title"><span class="title">综合</span> <span class="arrow down"></span></button> <button type="button" aria-label="综合" class="mobile-dropdown-title"><span class="title">综合</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/tech/" class="nav-link">
  技术
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/docs/" class="nav-link">
  文档
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/notes/" class="nav-link router-link-active">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/summary/health/" class="nav-link">
  健康
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文字" class="dropdown-title"><span class="title">文字</span> <span class="arrow down"></span></button> <button type="button" aria-label="文字" class="mobile-dropdown-title"><span class="title">文字</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/book/" class="nav-link">
  书
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/foreign/" class="nav-link">
  外文
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/cognition/" class="nav-link">
  认知
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/music/" class="nav-link">
  音乐
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/video/" class="nav-link">
  视频
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/gard/" class="nav-link">
  圈子
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/kobe/" class="nav-link">
  KOBE
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/s/" class="nav-link">
  大S
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/culture/" class="nav-link">
  文化
</a></li><li class="dropdown-item"><!----> <a href="/web-bookmarks/other/another/" class="nav-link">
  其它
</a></li></ul></div></div> <a href="https://github.com/Neveryu/web-bookmarks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web-bookmarks/summary/notes/" aria-current="page" class="sidebar-link">笔记</a></li><li><a href="/web-bookmarks/summary/notes/a1.html" class="sidebar-link">algorithms（算法）</a></li><li><a href="/web-bookmarks/summary/notes/angular.html" class="sidebar-link">Angular 入门笔记（超棒）</a></li><li><a href="/web-bookmarks/summary/notes/angular1.html" class="sidebar-link">Angular 高阶内容笔记（超棒）</a></li><li><a href="/web-bookmarks/summary/notes/angular2.html" class="sidebar-link">Angular 实战中的总结与技术点剖析</a></li><li><a href="/web-bookmarks/summary/notes/html5shiv.html" class="sidebar-link">html5shiv</a></li><li><a href="/web-bookmarks/summary/notes/js1.html" class="sidebar-link">JavaScript基础笔记</a></li><li><a href="/web-bookmarks/summary/notes/mobile1.html" class="sidebar-link">移动端开发</a></li><li><a href="/web-bookmarks/summary/notes/node-base.html" class="sidebar-link">Node.js 基础</a></li><li><a href="/web-bookmarks/summary/notes/respond.html" class="sidebar-link">Respond.js</a></li><li><a href="/web-bookmarks/summary/notes/sass1.html" class="sidebar-link">sass、Compass 安装使用</a></li><li><a href="/web-bookmarks/summary/notes/three-first.html" aria-current="page" class="active sidebar-link">THREE 知识体系梳理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#如何系统的了解和学习-three-js" class="sidebar-link">如何系统的了解和学习 Three.js</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#加载一个-obj-模型-剖析" class="sidebar-link">加载一个 obj 模型（剖析）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_1、定义objloader2example" class="sidebar-link">1、定义OBJLoader2Example</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_2、objloader2example-的构造方法" class="sidebar-link">2、OBJLoader2Example 的构造方法</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_3、initgl" class="sidebar-link">3、initGL()</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_4、initcontent" class="sidebar-link">4、initContent()</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_5、objectloader2-loadmtl" class="sidebar-link">5、ObjectLoader2#loadMtl()</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_6、objloader2-load" class="sidebar-link">6、ObjLoader2#load()</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#渲染-render-分析" class="sidebar-link">渲染(render)分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_1、构建" class="sidebar-link">1、构建</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_2、初始化" class="sidebar-link">2、初始化</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_3、渲染" class="sidebar-link">3、渲染</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#_4、渲染分析" class="sidebar-link">4、渲染分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#图形绘制基础" class="sidebar-link">图形绘制基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#图形绘制主要流程" class="sidebar-link">图形绘制主要流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#光和影" class="sidebar-link">光和影</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#light" class="sidebar-link">Light</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#ambientlight" class="sidebar-link">AmbientLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#directionallight" class="sidebar-link">DirectionalLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#hemispherelight" class="sidebar-link">HemisphereLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#pointlight" class="sidebar-link">PointLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#rectarealight" class="sidebar-link">RectAreaLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#spotlight" class="sidebar-link">SpotLight</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#纹理" class="sidebar-link">纹理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#canvastexture" class="sidebar-link">CanvasTexture</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#compressedtexture" class="sidebar-link">CompressedTexture</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#cubetexture" class="sidebar-link">CubeTexture</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#datatexture" class="sidebar-link">DataTexture</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#datatexture3d" class="sidebar-link">DataTexture3D</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#depthtexture" class="sidebar-link">DepthTexture</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#videotexture" class="sidebar-link">VideoTexture</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#材质" class="sidebar-link">材质</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#场景和雾" class="sidebar-link">场景和雾</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#相机" class="sidebar-link">相机</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#核心类" class="sidebar-link">核心类</a></li><li class="sidebar-sub-header"><a href="/web-bookmarks/summary/notes/three-first.html#补充" class="sidebar-link">补充</a></li></ul></li><li><a href="/web-bookmarks/summary/notes/three1.html" class="sidebar-link">Three.js开发指南（第3版）</a></li><li><a href="/web-bookmarks/summary/notes/ts.html" class="sidebar-link">TypeScript</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="three-知识体系梳理"><a href="#three-知识体系梳理" class="header-anchor">#</a> THREE 知识体系梳理</h1> <h2 id="如何系统的了解和学习-three-js"><a href="#如何系统的了解和学习-three-js" class="header-anchor">#</a> 如何系统的了解和学习 Three.js</h2> <p>【准备资料】提前下载好一个你当前想使用的 <a href="https://github.com/mrdoob/three.js/releases" target="_blank" rel="noopener noreferrer">three.js 版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 到你的电脑本地来。</p> <p>解压后，用本地服务器的方式来打开它，是最合适的。目录结构，说明如下：</p> <p><img src="/web-bookmarks/assets/img/three-file-desc.71a4962d.png" alt=""></p> <p>three.js 中模块内容介绍如下：</p> <p><img src="data:image/jpeg;base64,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" alt=""></p> <table><thead><tr><th style="text-align:center;">模块名</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">animation</td> <td style="text-align:center;">动画模块</td></tr> <tr><td style="text-align:center;">audio</td> <td style="text-align:center;">音频</td></tr> <tr><td style="text-align:center;">cameras</td> <td style="text-align:center;">3D 相机</td></tr> <tr><td style="text-align:center;">extras</td> <td style="text-align:center;">其他</td></tr> <tr><td style="text-align:center;">geometrics</td> <td style="text-align:center;">基础几何对象</td></tr> <tr><td style="text-align:center;">helpers</td> <td style="text-align:center;">帮助类</td></tr> <tr><td style="text-align:center;">lights</td> <td style="text-align:center;">光源</td></tr> <tr><td style="text-align:center;">loaders</td> <td style="text-align:center;">3D 模型加载器</td></tr> <tr><td style="text-align:center;">materials</td> <td style="text-align:center;">材质</td></tr> <tr><td style="text-align:center;">textures</td> <td style="text-align:center;">纹理</td></tr> <tr><td style="text-align:center;">objects</td> <td style="text-align:center;">用于加入到场景中的对象</td></tr> <tr><td style="text-align:center;">renderers</td> <td style="text-align:center;">WebGL渲染，glsl 定义</td></tr> <tr><td style="text-align:center;">scenes</td> <td style="text-align:center;">场景</td></tr> <tr><td style="text-align:center;">core</td> <td style="text-align:center;">属性，几何，3D对象，光线跟踪等</td></tr> <tr><td style="text-align:center;">math</td> <td style="text-align:center;">向量，矩阵等</td></tr></tbody></table> <h2 id="加载一个-obj-模型-剖析"><a href="#加载一个-obj-模型-剖析" class="header-anchor">#</a> 加载一个 obj 模型（剖析）</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>glFullscreen<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 渲染 3D 场景的 canvas --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>example<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- dat gui 的 div 占位--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 导入 threejs 核心库 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../build/three.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 导入 camera controller，用于响应鼠标/手指的拖动，放大，旋转等操作 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/controls/TrackballControls.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 材质加载 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/loaders/MTLLoader.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 三方库 dat gui 库的导入--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/libs/dat.gui.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 三方库 stats 的导入--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/libs/stats.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 构建 mesh,texture 等支持 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/loaders/LoaderSupport.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 加载 obj 的主要实现 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/loaders/OBJLoader2.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>模型加载时序图如下：
<img src="/web-bookmarks/assets/img/three-objload-desc.913904b0.jpg" alt=""></p> <h3 id="_1、定义objloader2example"><a href="#_1、定义objloader2example" class="header-anchor">#</a> 1、定义OBJLoader2Example</h3> <p>这里先定义了函数 OBJLoader2Example()，然后再指定OBJLoader2Example的 prototype 的 constructor 为 OBJLoader2Example() 本身，这也就定义了一个 “类” OBJLoader2Example，我们可以使用这个类来声明新的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">OBJLoader2Example</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">elementToBindTo</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">OBJLoader2Example</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">constructor</span><span class="token operator">:</span> OBJLoader2Example<span class="token punctuation">,</span>
  <span class="token function-variable function">initGL</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">initContent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">_reportProgress</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">resizeDisplayGL</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">recalcAspectRatio</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">resetCamera</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">updateCamera</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2、objloader2example-的构造方法"><a href="#_2、objloader2example-的构造方法" class="header-anchor">#</a> 2、OBJLoader2Example 的构造方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">OBJLoader2Example</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">elementToBindTo</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 渲染器，后面它会绑定 canvas 节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// canvas 节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> elementToBindTo<span class="token punctuation">;</span>
  <span class="token comment">// 视图比例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>aspectRatio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recalcAspectRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3D 场景</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>scene <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 默认相机参数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cameraDefaults <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相机的位置，就是相机该摆在哪里</span>
    <span class="token literal-property property">posCamera</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">175.0</span><span class="token punctuation">,</span> <span class="token number">500.0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 相机的目标</span>
    <span class="token literal-property property">posCameraTarget</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 近截面</span>
    <span class="token literal-property property">near</span><span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token comment">// 远截面</span>
    <span class="token literal-property property">far</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token comment">// 视景体夹角</span>
    <span class="token literal-property property">fov</span><span class="token operator">:</span> <span class="token number">45</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 3D 相机</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>camera <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 3D 相机的目标，就是相机该盯着哪里看</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cameraTarget <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cameraDefaults<span class="token punctuation">.</span>posCameraTarget<span class="token punctuation">;</span>
  <span class="token comment">// 3D 相机控制器，当然也可理解就是一个手势控制器</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>controls <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>构造方法主要是属性的定义，代码中添加了注释简要介绍了各个属性的作用，总体来说就是3D场景、3D 相机，相机控制器以及最重要的渲染器，渲染器绑定了 canvas，3D 场景及其所有的物件都会通过这个渲染器渲染到 canvas 中去。</p> <h3 id="_3、initgl"><a href="#_3、initgl" class="header-anchor">#</a> 3、initGL()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">initGL</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建渲染器</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>WebGLRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 绑定 canvas</span>
    <span class="token literal-property property">canvas</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">,</span>
    <span class="token comment">// 抗锯齿</span>
    <span class="token literal-property property">antialias</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">autoClear</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setClearColor</span><span class="token punctuation">(</span> <span class="token number">0x050505</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化透视投影相机，这是一个三角的景锥体，物体在其里面呈现的效果是近大远小</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>PerspectiveCamera</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cameraDefaults<span class="token punctuation">.</span>fov<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectRatio<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cameraDefaults<span class="token punctuation">.</span>near<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cameraDefaults<span class="token punctuation">.</span>far <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 controller</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>controls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>TrackballControls</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>domElement <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 添加环境光与平行光</span>
  <span class="token keyword">var</span> ambientLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>AmbientLight</span><span class="token punctuation">(</span> <span class="token number">0x404040</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> directionalLight1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>DirectionalLight</span><span class="token punctuation">(</span> <span class="token number">0xC0C090</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> directionalLight2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>DirectionalLight</span><span class="token punctuation">(</span> <span class="token number">0xC0C090</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  directionalLight1<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  directionalLight2<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> directionalLight1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> directionalLight2 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> ambientLight <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 添加调试网格</span>
  <span class="token keyword">var</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>GridHelper</span><span class="token punctuation">(</span> <span class="token number">1200</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">0xFF4444</span><span class="token punctuation">,</span> <span class="token number">0x404040</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> helper <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>initGL() 方法中初始化了各个属性，同时还添加了环境光与平行光源，以用于调试的网格帮助模型。在 3D 场景中很多物体都可看成是一个模型，如这里的光源。而 camera 在有一些渲染框架中也会被认为是一个模型，但其只是一个用于参与 3D 渲染时的参数。camera 最主要的作用是决定了投影矩阵，在投影矩阵内的物体可见，而不在里面则不可见。</p> <h3 id="_4、initcontent"><a href="#_4、initcontent" class="header-anchor">#</a> 4、initContent()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">initContent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> modelName <span class="token operator">=</span> <span class="token string">'female02'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reportProgress</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token literal-property property">detail</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Loading: '</span> <span class="token operator">+</span> modelName <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 声明 ObjLoader2 对象</span>
  <span class="token keyword">var</span> objLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>OBJLoader2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 模型加载完成的 call back，加载完成后便会把模型加载到场景中</span>
  <span class="token keyword">var</span> <span class="token function-variable function">callbackOnLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">event</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scope<span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>loaderRootNode <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'Loading complete: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>modelName <span class="token punctuation">)</span><span class="token punctuation">;</span>
    scope<span class="token punctuation">.</span><span class="token function">_reportProgress</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token literal-property property">detail</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 材质加载完成的回调，材质加载完成后便会进一步加 obj</span>
  <span class="token keyword">var</span> <span class="token function-variable function">onLoadMtl</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">materials</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    objLoader<span class="token punctuation">.</span><span class="token function">setModelName</span><span class="token punctuation">(</span> modelName <span class="token punctuation">)</span><span class="token punctuation">;</span>
    objLoader<span class="token punctuation">.</span><span class="token function">setMaterials</span><span class="token punctuation">(</span> materials <span class="token punctuation">)</span><span class="token punctuation">;</span>
    objLoader<span class="token punctuation">.</span><span class="token function">setLogging</span><span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开始加载 obj</span>
    objLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span> <span class="token string">'models/obj/female02/female02.obj'</span><span class="token punctuation">,</span> callbackOnLoad<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始加载材质</span>
  objLoader<span class="token punctuation">.</span><span class="token function">loadMtl</span><span class="token punctuation">(</span> <span class="token string">'models/obj/female02/female02.mtl'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> onLoadMtl <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>内容加载这一块是重点，其主要是通过 ObjLoader2 先是加载了材质然后加载模型。关于 obj 和 mtl 文件， 请打开 <code>female02.obj</code> 和 <code>female02.mtl</code>，可以发现它就是一个文本文件，通过注释来感受一下其文件格式如何。</p> <p><strong>female02.obj部分数据</strong></p> <div class="language- extra-class"><pre class="language-text"><code># Blender v2.54 (sub 0) OBJ File: ''
# www.blender.org
# obj对应的材质文件
mtllib female02.mtl
# o 对象名称(Object name)
o mesh1.002_mesh1-geometry
# 顶点
v 15.257854 104.640892 8.680023
v 14.044281 104.444138 11.718708
v 15.763498 98.955704 11.529579
......
# 纹理坐标
vt 0.389887 0.679023
vt 0.361250 0.679023
vt 0.361250 0.643346
......
# 顶点法线
vn 0.945372 0.300211 0.126926
vn 0.794275 0.212683 0.569079
vn 0.792047 0.184729 0.581805
......
# group
g mesh1.002_mesh1-geometry__03_-_Default1noCulli__03_-_Default1noCulli
# 当前图元所用材质
usemtl _03_-_Default1noCulli__03_-_Default1noCulli
s off
# v1/vt1/vn1 v2/vt2/vn2 v3/vt3/vn3(索引起始于1)    
f 1/1/1 2/2/2 3/3/3
f 1/1/1 4/4/4 2/2/2
f 4/4/4 1/1/1 5/5/5
......
</code></pre></div><p><strong>female02.mtl部分数据</strong></p> <div class="language- extra-class"><pre class="language-text"><code>......
# 定义一个名为 _03_-_Default1noCulli__03_-_Default1noCulli 的材质
newmtl _03_-_Default1noCulli__03_-_Default1noCulli
# 反射指数 定义了反射高光度。该值越高则高光越密集，一般取值范围在0~1000。
Ns 154.901961
# 材质的环境光（ambient color）
Ka 0.000000 0.000000 0.000000
# 散射光（diffuse color）用Kd
Kd 0.640000 0.640000 0.640000
# 镜面光（specular color）用Ks
Ks 0.165000 0.165000 0.165000
# 折射值 可在0.001到10之间进行取值。若取值为1.0，光在通过物体的时候不发生弯曲。玻璃的折射率为1.5。
Ni 1.000000
# 渐隐指数描述 参数factor表示物体融入背景的数量，取值范围为0.0~1.0，取值为1.0表示完全不透明，取值为0.0时表示完全透明。
d 1.000000
# 指定材质的光照模型。illum后面可接0~10范围内的数字参数。各个参数代表不同的光照模型
illum 2
# 为漫反射指定颜色纹理文件
map_Kd 03_-_Default1noCulling.JPG
......
</code></pre></div><p>关于 obj 和 mtl 文件中各个字段的意思都在注释中有说明了，至于每个字段参数如何使用，就需要对 OpenGL 如何渲染模型有一定的了解了。继续来看材质的加载和obj 的加载。</p> <h3 id="_5、objectloader2-loadmtl"><a href="#_5、objectloader2-loadmtl" class="header-anchor">#</a> 5、ObjectLoader2#loadMtl()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">loadMtl</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> content<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> crossOrigin<span class="token punctuation">,</span> materialOptions</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadMtl</span><span class="token punctuation">(</span> resource<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> crossOrigin<span class="token punctuation">,</span> materialOptions <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>调用了内部的 <code>_loadMtl()</code>，<code>_loadMtl()</code> 函数的实现代码是有点多的，不过不要紧，我给做了精简。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_loadMtl</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">resource<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> crossOrigin<span class="token punctuation">,</span> materialOptions</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 7. 创建了 materialCreator 后，就会加载到这里。这里最后通过 onLoad 通知给调用者，调用者继续加载模型。</span>
  <span class="token keyword">var</span> <span class="token function-variable function">processMaterials</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">materialCreator</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// 8.创建材质</span>
    materialCreator<span class="token punctuation">.</span><span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 9.回调给调用者</span>
    <span class="token function">onLoad</span><span class="token punctuation">(</span> materials<span class="token punctuation">,</span> materialCreator <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 1. 构建一个 MTLLoader</span>
  <span class="token keyword">var</span> mtlLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MTLLoader</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 4.文件加载成功后回调到 parseTextWithMtlLoader 这里</span>
  <span class="token keyword">var</span> <span class="token function-variable function">parseTextWithMtlLoader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">content</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    contentAsText <span class="token operator">=</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>LoaderUtils<span class="token punctuation">.</span><span class="token function">decodeText</span><span class="token punctuation">(</span> content <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// 5.对文件内容进行解析，解析完成后得到一个 materialCreator 对象，然后再调用 processMaterials</span>
    <span class="token function">processMaterials</span><span class="token punctuation">(</span> mtlLoader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span> contentAsText <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 2.构建一个 FileLoader</span>
  <span class="token keyword">var</span> fileLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>FileLoader</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 3. 加载文件，文件加载成功能后回调 parseTextWithMtlLoader</span>
  fileLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span> resource<span class="token punctuation">.</span>url<span class="token punctuation">,</span> parseTextWithMtlLoader<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注释里包含了材质加载的整个逻辑，一共 9 个步骤，但这里重点只需要关注以下 3 个步骤：</p> <p><strong>(1)文件加载——FileLoader#load()</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FileLoader 是 ThreeJs 库中的代码，关于 load() 方法中的前后代码这里都略去了，重点是知道了它是通过 Get 请求来获取的。</p> <p><strong>(2)文件parse——MTLLoader#parse()</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">parse</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">text<span class="token punctuation">,</span> path</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> delimiter_pattern <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> materialsInfo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">;</span>
    line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> line<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Blank line or comment ignore</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> pos <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span> <span class="token string">' '</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token punctuation">(</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">?</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> pos <span class="token punctuation">)</span> <span class="token operator">:</span> line<span class="token punctuation">;</span>
    key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token punctuation">(</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">?</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> key <span class="token operator">===</span> <span class="token string">'newmtl'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// New material</span>
      info <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
      materialsInfo<span class="token punctuation">[</span> value <span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> key <span class="token operator">===</span> <span class="token string">'ka'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'kd'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'ks'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ss <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span> delimiter_pattern<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">[</span> key <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> ss<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> ss<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> ss<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        info<span class="token punctuation">[</span> key <span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> materialCreator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MTLLoader<span class="token punctuation">.</span>MaterialCreator</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath <span class="token operator">||</span> path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>materialOptions <span class="token punctuation">)</span><span class="token punctuation">;</span>
  materialCreator<span class="token punctuation">.</span><span class="token function">setCrossOrigin</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>crossOrigin <span class="token punctuation">)</span><span class="token punctuation">;</span>
  materialCreator<span class="token punctuation">.</span><span class="token function">setManager</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
  materialCreator<span class="token punctuation">.</span><span class="token function">setMaterials</span><span class="token punctuation">(</span> materialsInfo <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> materialCreator<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>parse()</code> 方法的代码看起来有点多，但其实很简单，就是对着 mtl 文件一行一行的解析。这里的重点是创建了 MaterialCreator并且保存在了 materialsInfo 中。materialsInfo 是一个 map 对象，其中保存的值最重要的是包括了 <code>map_Kd</code>，这个在创建材质时要加载的纹理。</p> <p><strong>(3)创建材质——MaterialCreator#preload()</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">preload</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> mn <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>materialsInfo <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> mn <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>preload() 中就遍历每一个 material 然后分别调用 create() 。而 create() 又是进一步调用了 <code>createMaterial_()</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">createMaterial_</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">materialName</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create material</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> mat <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>materialsInfo<span class="token punctuation">[</span> materialName <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> materialName<span class="token punctuation">,</span>
    <span class="token literal-property property">side</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>side
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">resolveURL</span><span class="token punctuation">(</span> <span class="token parameter">baseUrl<span class="token punctuation">,</span> url</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">typeof</span> url <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> url <span class="token operator">===</span> <span class="token string">''</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment">// Absolute URL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token keyword">return</span> baseUrl <span class="token operator">+</span> url<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token parameter">mapType<span class="token punctuation">,</span> value</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> params<span class="token punctuation">[</span> mapType <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Keep the first encountered texture</span>
    <span class="token keyword">var</span> texParams <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">getTextureParams</span><span class="token punctuation">(</span> value<span class="token punctuation">,</span> params <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> map <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">loadTexture</span><span class="token punctuation">(</span> <span class="token function">resolveURL</span><span class="token punctuation">(</span> scope<span class="token punctuation">.</span>baseUrl<span class="token punctuation">,</span> texParams<span class="token punctuation">.</span>url <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span>repeat<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> texParams<span class="token punctuation">.</span>scale <span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span>offset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> texParams<span class="token punctuation">.</span>offset <span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span>wrapS <span class="token operator">=</span> scope<span class="token punctuation">.</span>wrap<span class="token punctuation">;</span>
    map<span class="token punctuation">.</span>wrapT <span class="token operator">=</span> scope<span class="token punctuation">.</span>wrap<span class="token punctuation">;</span>
    params<span class="token punctuation">[</span> mapType <span class="token punctuation">]</span> <span class="token operator">=</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> prop <span class="token keyword">in</span> mat <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> mat<span class="token punctuation">[</span> prop <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> n<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> value <span class="token operator">===</span> <span class="token string">''</span> <span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> prop<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Ns is material specular exponent</span>
      <span class="token keyword">case</span> <span class="token string">'kd'</span><span class="token operator">:</span>
        <span class="token comment">// Diffuse color (color under white light) using RGB values</span>
        params<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'ks'</span><span class="token operator">:</span>
        <span class="token comment">// Specular color (color when light is reflected from shiny surface) using RGB values</span>
        params<span class="token punctuation">.</span>specular <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'map_kd'</span><span class="token operator">:</span>
        <span class="token comment">// Diffuse texture map</span>
        <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'map_ks'</span><span class="token operator">:</span>
        <span class="token comment">// Specular map</span>
        <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token string">&quot;specularMap&quot;</span><span class="token punctuation">,</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'norm'</span><span class="token operator">:</span>
        <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token string">&quot;normalMap&quot;</span><span class="token punctuation">,</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'map_bump'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'bump'</span><span class="token operator">:</span>
        <span class="token comment">// Bump texture map</span>
        <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token string">&quot;bumpMap&quot;</span><span class="token punctuation">,</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'map_d'</span><span class="token operator">:</span>
        <span class="token comment">// Alpha map</span>
        <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token string">&quot;alphaMap&quot;</span><span class="token punctuation">,</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span>transparent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'ns'</span><span class="token operator">:</span>
        <span class="token comment">// The specular exponent (defines the focus of the specular highlight)</span>
        <span class="token comment">// A high exponent results in a tight, concentrated highlight. Ns values normally range from 0 to 1000.</span>
        params<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span>
        n <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> n <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          params<span class="token punctuation">.</span>opacity <span class="token operator">=</span> n<span class="token punctuation">;</span>
          params<span class="token punctuation">.</span>transparent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'tr'</span><span class="token operator">:</span>
        n <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>invertTrProperty <span class="token punctuation">)</span> n <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> n<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          params<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> n<span class="token punctuation">;</span>
          params<span class="token punctuation">.</span>transparent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>materials<span class="token punctuation">[</span> materialName <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshPhongMaterial</span><span class="token punctuation">(</span> params <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>materials<span class="token punctuation">[</span> materialName <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>这里就是告知我们该怎么用 mtl 文件中的每个字段了，这里主要关注一下纹理图片是如何加载的，其他的字段参数再看看 mtl 的注释就可以理解了。map-kd、map_ks、norm、map_bump、bump 以及 map_d 的处理是调用了setMapForType()，他们都是去加载纹理的，只是纹理的形式不一样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setMapForType</span><span class="token punctuation">(</span> <span class="token parameter">mapType<span class="token punctuation">,</span> value</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> map <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">loadTexture</span><span class="token punctuation">(</span> <span class="token function">resolveURL</span><span class="token punctuation">(</span> scope<span class="token punctuation">.</span>baseUrl<span class="token punctuation">,</span> texParams<span class="token punctuation">.</span>url <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 loadTexture() 就是加载纹理的实现，一般来说在材质文件中对纹理的地址要写成相对的，这里会根据材质的地址的 base url 来 resolve 出一个纹理的地址。继续来看loadTexture()。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">loadTexture</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> loader <span class="token operator">=</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>Loader<span class="token punctuation">.</span>Handlers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>TextureLoader</span><span class="token punctuation">(</span> manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  texture <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span> url<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其主要是构建一个 TextureLoader，然后调用其 load() 进行加载。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageLoader</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span> url<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">image</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>又进一步通过了 ImageLoader 来加载。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> image <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span> <span class="token string">'http://www.w3.org/1999/xhtml'</span><span class="token punctuation">,</span> <span class="token string">'img'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
  <span class="token keyword">return</span> image<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>原来图片的加载是通过创建一个 <code>&lt;img&gt;</code> 标记来加载的。创建一个 <code>&lt;img&gt;</code> 标记，在不添加到 dom 树中的情况下，只要给 src 赋了值，就会去下载图片了。</p> <p>到这里，终于把材质以及纹理的加载分析完了。接下来继续分析 obj 的加载。</p> <h3 id="_6、objloader2-load"><a href="#_6、objloader2-load" class="header-anchor">#</a> 6、ObjLoader2#load()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onMeshAlter<span class="token punctuation">,</span> useAsync</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>LoaderSupport<span class="token punctuation">.</span>ResourceDescriptor</span><span class="token punctuation">(</span> url<span class="token punctuation">,</span> <span class="token string">'OBJ'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadObj</span><span class="token punctuation">(</span> resource<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onMeshAlter<span class="token punctuation">,</span> useAsync <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>同样是进一步的调用，这里调用的是 <code>_loadObj()</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_loadObj</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">resource<span class="token punctuation">,</span> onLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onMeshAlter<span class="token punctuation">,</span> useAsync</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> <span class="token function-variable function">fileLoaderOnLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">content</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// 3.解析 obj</span>
    <span class="token literal-property property">loaderRootNode</span><span class="token operator">:</span> scope<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span> content <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 1.构建 FileLoader</span>
  <span class="token keyword">var</span> fileLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>FileLoader</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 2.加载文件，这里在加载 mtl 的时候已经分析过了，并且最后会回调到 fileLoaderOnLoad</span>
  fileLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span> resource<span class="token punctuation">.</span>name<span class="token punctuation">,</span> fileLoaderOnLoad<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onError <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>_loadObj()</code> 的代码这里也精简了一下，并在注释中说明了逻辑。文件加载已经在前面分析过了，这里就关注一下解析 obj。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
* Parses OBJ data synchronously from arraybuffer or string.
*
* @param {arraybuffer|string} content OBJ data as Uint8Array or String
*/</span>
<span class="token function-variable function">parse</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">content</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 1.初始化 meshBuilder</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>meshBuilder<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 2.创建一个 Parser</span>
  <span class="token keyword">var</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>OBJLoader2<span class="token punctuation">.</span>Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">var</span> <span class="token function-variable function">onMeshLoaded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">payload</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.从 meshBuilder 中获取 mesh ，并把 mesh 都加到节点中</span>
    <span class="token keyword">var</span> meshes <span class="token operator">=</span> scope<span class="token punctuation">.</span>meshBuilder<span class="token punctuation">.</span><span class="token function">processPayload</span><span class="token punctuation">(</span> payload <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> mesh<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token keyword">in</span> meshes <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mesh <span class="token operator">=</span> meshes<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">;</span>
      scope<span class="token punctuation">.</span>loaderRootNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> mesh <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 3.解析文本，因为这里传输的就是文本</span>
  parser<span class="token punctuation">.</span><span class="token function">parseText</span><span class="token punctuation">(</span> content <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的重点是parseText()。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">parseText</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">text</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> char<span class="token punctuation">,</span> word <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> bufferPointer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> slashesCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processLine</span><span class="token punctuation">(</span> buffer<span class="token punctuation">,</span> bufferPointer<span class="token punctuation">,</span> slashesCount <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样，省略的部分这里可以先不看，来看一看具体解析 obj 文件的 processLine()。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">processLine</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">buffer<span class="token punctuation">,</span> bufferPointer<span class="token punctuation">,</span> slashesCount</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> bufferPointer <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">reconstructString</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">content<span class="token punctuation">,</span> legacyMode<span class="token punctuation">,</span> start<span class="token punctuation">,</span> stop</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> line <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> stop <span class="token operator">&gt;</span> start <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> i<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> legacyMode <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stop<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> line <span class="token operator">+=</span> content<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stop<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> line <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span> content<span class="token punctuation">[</span> i <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> line<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> bufferLength<span class="token punctuation">,</span> length<span class="token punctuation">,</span> i<span class="token punctuation">,</span> lineDesignation<span class="token punctuation">;</span>
  lineDesignation <span class="token operator">=</span> buffer <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span> lineDesignation <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'v'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> bufferPointer <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'vt'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uvs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uvs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'vn'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'f'</span><span class="token operator">:</span>
      bufferLength <span class="token operator">=</span> bufferPointer <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">// &quot;f vertex ...&quot;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> slashesCount <span class="token operator">===</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &quot;f vertex/uv ...&quot;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span>  <span class="token punctuation">(</span> bufferLength <span class="token operator">===</span> slashesCount <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &quot;f vertex/uv/normal ...&quot;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span>  <span class="token punctuation">(</span> bufferLength <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">===</span> slashesCount <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">4</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &quot;f vertex//normal ...&quot;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'l'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'p'</span><span class="token operator">:</span>
      bufferLength <span class="token operator">=</span> bufferPointer <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> bufferLength <span class="token operator">===</span> slashesCount <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkFaceType</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> lineDesignation <span class="token operator">===</span> <span class="token string">'l'</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">5</span> <span class="token operator">:</span> <span class="token number">6</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bufferLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildFace</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> i <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pushSmoothingGroup</span><span class="token punctuation">(</span> buffer<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'g'</span><span class="token operator">:</span>
      <span class="token comment">// 'g' leads to creation of mesh if valid data (faces declaration was done before), otherwise only groupName gets set</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processCompletedMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>groupName <span class="token operator">=</span> <span class="token function">reconstructString</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentRef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>legacyMode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>lineByte <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>currentByte <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'o'</span><span class="token operator">:</span>
      <span class="token comment">// 'o' is meta-information and usually does not result in creation of new meshes, but can be enforced with &quot;useOAsMesh&quot;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>useOAsMesh <span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processCompletedMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>objectName <span class="token operator">=</span> <span class="token function">reconstructString</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentRef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>legacyMode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>lineByte <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>currentByte <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'mtllib'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>mtllibName <span class="token operator">=</span> <span class="token function">reconstructString</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentRef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>legacyMode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>lineByte <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>currentByte <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'usemtl'</span><span class="token operator">:</span>
      <span class="token keyword">var</span> mtlName <span class="token operator">=</span> <span class="token function">reconstructString</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentRef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>legacyMode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>lineByte <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalCounts<span class="token punctuation">.</span>currentByte <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> mtlName <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>activeMtlName <span class="token operator">!==</span> mtlName <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>activeMtlName <span class="token operator">=</span> mtlName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rawMesh<span class="token punctuation">.</span>counts<span class="token punctuation">.</span>mtlCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSubGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>这段代码就比较长了，有 150 多行，但内容其实很简单，就是根据 obj 的文件格式进行解析。如果看到这里忘记了 obj 的文件格式，那建议先回顾一下。解析的过程已经非常细节了，就不详细展开了。这里最后的解析结果就是顶点，纹理坐标以及法向根据 face 的索引进行展开，得到的结果是 vvv | vtvt | vnvnvn 这样的 n 组顶点数组 以及 n 组索引数组。顶点数组，索引数组以及材质/纹理构成了用于渲染的3D网格 mesh。</p> <p>到这里 obj 的加载也分析完了。obj 的加载是主体，但也是最简单的。容易出问题的是在材质和纹理的加载上，需要注意的问题比较多。</p> <p><a href="https://www.jianshu.com/p/f8747b905393" target="_blank" rel="noopener noreferrer">⬆️ThreeJs学习笔记——ObjLoader加载以及渲染分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="渲染-render-分析"><a href="#渲染-render-分析" class="header-anchor">#</a> 渲染(render)分析</h2> <h3 id="_1、构建"><a href="#_1、构建" class="header-anchor">#</a> 1、构建</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 构建渲染器 WebGLRenderer            </span>
<span class="token keyword">var</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>WebGLRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置显示比例</span>
renderer<span class="token punctuation">.</span><span class="token function">setPixelRatio</span><span class="token punctuation">(</span> window<span class="token punctuation">.</span>devicePixelRatio <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建一个透视投影的相机</span>
<span class="token keyword">var</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>PerspectiveCamera</span><span class="token punctuation">(</span> <span class="token number">35</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建一个轨道控制器，主要就是通过鼠标来控制相机沿目标物体旋转，从而达到像在旋转场景一样，可以从各个不同角度观察物体</span>
<span class="token keyword">var</span> controls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>OrbitControls</span><span class="token punctuation">(</span> camera<span class="token punctuation">,</span> renderer<span class="token punctuation">.</span>domElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建场景</span>
<span class="token keyword">var</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建Phong网格材质MeshPhongMaterial，该材质可以模拟具有镜面高光的光泽表面，一个用于接收阴影的平面，一个用于场景中的物体 Box</span>
<span class="token keyword">var</span> matFloor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshPhongMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> matBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshPhongMaterial</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token number">0xaaaaaa</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建几何体，同样分别用于 平面 和 Box</span>
<span class="token keyword">var</span> geoFloor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>PlaneBufferGeometry</span><span class="token punctuation">(</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> geoBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>BoxBufferGeometry</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建平面网格 mesh</span>
<span class="token keyword">var</span> mshFloor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span> geoFloor<span class="token punctuation">,</span> matFloor <span class="token punctuation">)</span><span class="token punctuation">;</span>
mshFloor<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token comment">// 构建 box 网格 mesh</span>
<span class="token keyword">var</span> mshBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span> geoBox<span class="token punctuation">,</span> matBox <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建环境光</span>
<span class="token keyword">var</span> ambient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>AmbientLight</span><span class="token punctuation">(</span> <span class="token number">0x111111</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建 3 个不同颜色的 聚光灯（SpotLight）</span>
<span class="token keyword">var</span> spotLight1 <span class="token operator">=</span> <span class="token function">createSpotlight</span><span class="token punctuation">(</span> <span class="token number">0xFF7F00</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> spotLight2 <span class="token operator">=</span> <span class="token function">createSpotlight</span><span class="token punctuation">(</span> <span class="token number">0x00FF7F</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> spotLight3 <span class="token operator">=</span> <span class="token function">createSpotlight</span><span class="token punctuation">(</span> <span class="token number">0x7F00FF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 声明用于描述聚光灯的 3 个不同光束帮助器</span>
<span class="token keyword">var</span> lightHelper1<span class="token punctuation">,</span> lightHelper2<span class="token punctuation">,</span> lightHelper3<span class="token punctuation">;</span>
</code></pre></div><p>上面代码中，基本上每一行都添加了详细的注释，其中有调用了一个内部的函数 createSpotlight() ，如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createSpotlight</span><span class="token punctuation">(</span> <span class="token parameter">color</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>SpotLight</span><span class="token punctuation">(</span> color<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  newObj<span class="token punctuation">.</span>castShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  newObj<span class="token punctuation">.</span>angle <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>
  newObj<span class="token punctuation">.</span>penumbra <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">;</span>
  newObj<span class="token punctuation">.</span>decay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  newObj<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

  newObj<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>mapSize<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  newObj<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>mapSize<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2、初始化"><a href="#_2、初始化" class="header-anchor">#</a> 2、初始化</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>

  <span class="token comment">// 将平面，box，环境光以及光源辅助器等全部添加到 scene 中</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> mshFloor <span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> mshBox <span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> ambient <span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> spotLight1<span class="token punctuation">,</span> spotLight2<span class="token punctuation">,</span> spotLight3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> lightHelper1<span class="token punctuation">,</span> lightHelper2<span class="token punctuation">,</span> lightHelper3 <span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> renderer<span class="token punctuation">.</span>domElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">onResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'resize'</span><span class="token punctuation">,</span> onResize<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  controls<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  controls<span class="token punctuation">.</span>maxPolarAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  controls<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初始化主要就是将平面，box ，光照这些都添加进场景中，但是要注意，相机并没有被添加进来。</p> <h3 id="_3、渲染"><a href="#_3、渲染" class="header-anchor">#</a> 3、渲染</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">TWEEN</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> lightHelper1 <span class="token punctuation">)</span> lightHelper1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> lightHelper2 <span class="token punctuation">)</span> lightHelper2<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> lightHelper3 <span class="token punctuation">)</span> lightHelper3<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span> render <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>渲染函数 render() 中最关键的调用渲染器的 WebGLRenderer#render() 方法同时去渲染场景和相机。</p> <p>根据上面的分析，以及对 ThreeJs 源码的分析，梳理出如下 2 个类图关系。
<img src="/web-bookmarks/assets/img/webgl-renderer.c4b79f20.jpg" alt="">
图中，渲染器负责同时渲染场景以及相机。而光照和网格都被添加到场景中。几何体以及材质都是网格的 2 个基本属性，也决定一个网格的形状和表面纹理。
<img src="/web-bookmarks/assets/img/three-render-object.d8c55e3f.jpg" alt="">
该图是对上图的补充，说明光照，相机以及网格都属于 Object3D 对象。在 ThreeJs 中还有许多的类都是继承自 Object3D 的。</p> <h3 id="_4、渲染分析"><a href="#_4、渲染分析" class="header-anchor">#</a> 4、渲染分析</h3> <h4 id="_1、webgl-的渲染管线"><a href="#_1、webgl-的渲染管线" class="header-anchor">#</a> 1、WebGL 的渲染管线</h4> <p>先来看一下 WebGL 的流水线渲染管线图，如下所示。这个是必须要了解的，我们可以不必完全理解渲染管线的每个步骤，但我们必须要知道渲染管线的这个流程。
<img src="/web-bookmarks/assets/img/three-webgl-processline.fa4e6c57.png" alt=""></p> <p>渲染管线指的是WebGL程序的执行过程，如上图所示，主要分为 4 个步骤：</p> <p>1、顶点着色器的处理，主要是一组矩阵变换操作，用来把3D模型（顶点和原型）投影到viewport上，输出是一个个的多边形，比如三角形。</p> <p>2、光栅化，也就是把三角形连接区域按一定的粒度逐行转化成片元（fragement），类似于2D空间中，可以把这些片元看做是3D空间的一个像素点。</p> <p>3、片元着色器的处理，为每个片元添加颜色或者纹理。只要给出纹理或者颜色，以及纹理坐标(uv)，管线就会根据纹理坐标进行插值运算，将纹理或者图片着色在相应的片元上。</p> <p>4、把3D空间的片元合并输出为2D像素数组并显示在屏幕上。</p> <h4 id="_2、webgl-一般的开发流程"><a href="#_2、webgl-一般的开发流程" class="header-anchor">#</a> 2、WebGL 一般的开发流程</h4> <p>这里仅根据 Open GL ES 的开发流程，绘制出如下流程图。
<img src="/web-bookmarks/assets/img/three-opengl-es.066a5f7c.jpg" alt="">
流程图中关键的第一步在于创建着色器(Shader)程序，着色器程序主要用 GLSL(GL Shading Language) 语言编写，其直接由 GPU 来执行。第二步是设置顶点，纹理以及其他属性，如我们创建的几何图元 Box，加载的 obj 文件，以及用于矩阵变换的模型矩阵，视图矩阵以及投影矩阵等。第三步便是进行顶点的绘制，如以点绘制，以直线绘制以及以三角形绘制，对于图元，大部分是以三角形绘制。</p> <h4 id="_3、坐标系以及矩阵变换"><a href="#_3、坐标系以及矩阵变换" class="header-anchor">#</a> 3、坐标系以及矩阵变换</h4> <p>关于坐标系与矩阵变换，这里一个幅图总结的很不错，画的很详细，一眼就能看出其中的意思。
<img src="/web-bookmarks/assets/img/three-x-y-z.160984ab.png" alt=""></p> <h4 id="_4、构造方法-webglrenderer"><a href="#_4、构造方法-webglrenderer" class="header-anchor">#</a> 4、构造方法 WebGLRenderer()</h4> <p>其初始化的属性很多。这里主要关注其 2 个最核心的属性 canvas 以及 context。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">WebGLRenderer</span><span class="token punctuation">(</span> <span class="token parameter">parameters</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'THREE.WebGLRenderer'</span><span class="token punctuation">,</span> <span class="token constant">REVISION</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  parameters <span class="token operator">=</span> parameters <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果参数中有 canvas，就有参数中的，如果没有就通过 document.createElementNS() 来创建一个。和 2D 的概念一样，这里的 canvas 主要是用来进行 3D 渲染的画布。</span>
  <span class="token keyword">var</span> _canvas <span class="token operator">=</span> parameters<span class="token punctuation">.</span>canvas <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> parameters<span class="token punctuation">.</span>canvas <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span> <span class="token string">'http://www.w3.org/1999/xhtml'</span><span class="token punctuation">,</span> <span class="token string">'canvas'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      _context <span class="token operator">=</span> parameters<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> parameters<span class="token punctuation">.</span>context <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// initialize</span>
  <span class="token keyword">var</span> _gl<span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 从 canvas 中获取 context。参数 webgl 是其中之一，其还可以获取 2d 的。这里获取到 webgl 的 context，那就意味者可以通过它进行 3D 绘制了。</span>
  _gl <span class="token operator">=</span> _context <span class="token operator">||</span> _canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span> <span class="token string">'webgl'</span><span class="token punctuation">,</span> contextAttributes <span class="token punctuation">)</span> <span class="token operator">||</span> _canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span> <span class="token string">'experimental-webgl'</span><span class="token punctuation">,</span> contextAttributes <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">function</span> <span class="token function">initGLContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    _this<span class="token punctuation">.</span>context <span class="token operator">=</span> _gl<span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上面的代码以及注释，canvas 就是 html 的标准元素 <code>&lt;canvas&gt;</code>，这玩意儿在 Android 那里也叫做 canvas，反正就代表画布的意思。而 context 则是从该画布获取到的 webgl 上下文，这个上下文是 WebGLRenderingContext，WebGLRenderingContext 接口提供基于 OpenGL ES 2.0 的绘图上下文，用于在 HTML <code>&lt;canvas&gt;</code> 元素内绘图。后续的关于 Open GL ES 的相关操作都是基于此进行的。当然，这里还只是创建了用于 Open GL ES 的 WebGLContext，还没有进行初始化。下面再来详细看看它在 initGLContext() 方法中是如何进行初始化的，初始化中具体又详细做了什么具体的事情。</p> <h4 id="_5、初始化上下文方法-initglcontext"><a href="#_5、初始化上下文方法-initglcontext" class="header-anchor">#</a> 5、初始化上下文方法 initGLContext()</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initGLContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">/**
         * 扩展特性
         */</span>
        extensions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLExtensions</span><span class="token punctuation">(</span> _gl <span class="token punctuation">)</span><span class="token punctuation">;</span>

        capabilities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLCapabilities</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> parameters <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> capabilities<span class="token punctuation">.</span>isWebGL2 <span class="token punctuation">)</span> <span class="token punctuation">{</span>

            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'WEBGL_depth_texture'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_texture_float'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_texture_half_float'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_texture_half_float_linear'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_standard_derivatives'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_element_index_uint'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'ANGLE_instanced_arrays'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'OES_texture_float_linear'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 工具类
         */</span>
        utils <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLUtils</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> capabilities <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 状态
         */</span>
        state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLState</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> utils<span class="token punctuation">,</span> capabilities <span class="token punctuation">)</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span><span class="token function">scissor</span><span class="token punctuation">(</span> _currentScissor<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> _scissor <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span> _pixelRatio <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span> _currentViewport<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> _viewport <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span> _pixelRatio <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLInfo</span><span class="token punctuation">(</span> _gl <span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 纹理辅助类
         */</span>
        textures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLTextures</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> state<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> capabilities<span class="token punctuation">,</span> utils<span class="token punctuation">,</span> info <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 属性存储辅助类，主要实现 JavaScript 中的变量或者数组、纹理图片传递到 WebGL 中
         */</span>
        attributes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLAttributes</span><span class="token punctuation">(</span> _gl <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 几何图元
         */</span>
        geometries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLGeometries</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> info <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * Object 类存储类
         */</span>
        objects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLObjects</span><span class="token punctuation">(</span> geometries<span class="token punctuation">,</span> info <span class="token punctuation">)</span><span class="token punctuation">;</span>
        morphtargets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLMorphtargets</span><span class="token punctuation">(</span> _gl <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * WebGL program
         */</span>
        programCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLPrograms</span><span class="token punctuation">(</span> _this<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> capabilities <span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderLists <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLRenderLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderStates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLRenderStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 背景
         */</span>
        background <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLBackground</span><span class="token punctuation">(</span> _this<span class="token punctuation">,</span> state<span class="token punctuation">,</span> objects<span class="token punctuation">,</span> _premultipliedAlpha <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * Buffer
         */</span>
        bufferRenderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLBufferRenderer</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> info<span class="token punctuation">,</span> capabilities <span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexedBufferRenderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebGLIndexedBufferRenderer</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> info<span class="token punctuation">,</span> capabilities <span class="token punctuation">)</span><span class="token punctuation">;</span>

        info<span class="token punctuation">.</span>programs <span class="token operator">=</span> programCache<span class="token punctuation">.</span>programs<span class="token punctuation">;</span>

        _this<span class="token punctuation">.</span>context <span class="token operator">=</span> _gl<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>capabilities <span class="token operator">=</span> capabilities<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>extensions <span class="token operator">=</span> extensions<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>renderLists <span class="token operator">=</span> renderLists<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>initGLContext() 方法中初始化了很多的组件，有的组件很容易就能看出来是作什么用的，而有的组件可能就没那么好知道意思，需要等到具体分析 render() 方法时，用到时再来理解。不过，虽然 initGLContext() 方法中看起来有很多的组件初始化，但实质这些组件也只是进行一个最基本的构造而已，没有进一步更深入的过程。因此，这里也粗略的看一下即可。</p> <h4 id="_6、webglrenderer-render-函数分析"><a href="#_6、webglrenderer-render-函数分析" class="header-anchor">#</a> 6、WebGLRenderer#render() 函数分析</h4> <p>整个 render 的过程是十分复杂的，也是漫长的，需要我们耐心去看，去理解。先来简单过一下它的时序图。
<img src="/web-bookmarks/assets/img/three-webgl-renderer-process.111bd35a.jpg" alt="">
从时序图可见，其涉及到的相对象以及步骤是比较多的，共 20 步。其中涉及到的主要对象有：Scene, Camera, WebGLRenderStates, WebGLRenderLists, WebGLBackground, WebGLProgram, <code>_gl</code>, WebGLBufferRenderer。我们比较熟悉的是 Scene，因为我们的Object / Mesh 都是被添加到它里面的，另外还有 Camera，我们必须要有一个相机来告诉我们以怎么样的视角来观看这个 3D 世界。另外一些不熟悉的对象，WebGLRenderList 管理着我们需要拿去 render 的 Object / Mesh，WebGLBackground 描述了场景的背景，WebGLProgram 则创建了用于链接、执行 Shader 的程序，而 WebGLBufferRenderer 则是整个 3D 世界被 render 到的目的地。
这里不会按照时序图，逐步逐步地进行分析，而是挑重点，同时保持与前面所述的 OpenGL ES 的流程一致性上进行分析。</p> <h5 id="render-函数"><a href="#render-函数" class="header-anchor">#</a> render() 函数</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> renderTarget<span class="token punctuation">,</span> forceClear</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 前面是一些参数的校验，这里省略</span>
    <span class="token comment">// 1.reset caching for this frame</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// 2.update scene graph</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> scene<span class="token punctuation">.</span>autoUpdate <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> scene<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.update camera matrices and frustum</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> camera<span class="token punctuation">.</span>parent <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 4. init WebGLRenderState</span>

    currentRenderState <span class="token operator">=</span> renderStates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentRenderState<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    scene<span class="token punctuation">.</span><span class="token function">onBeforeRender</span><span class="token punctuation">(</span> _this<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> renderTarget <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.视景体矩阵计算，为相机的投影矩阵与相机的世界矩阵的逆矩阵的叉乘？</span>
    _projScreenMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse <span class="token punctuation">)</span><span class="token punctuation">;</span>
    _frustum<span class="token punctuation">.</span><span class="token function">setFromMatrix</span><span class="token punctuation">(</span> _projScreenMatrix <span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    _localClippingEnabled <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>localClippingEnabled<span class="token punctuation">;</span>
    _clippingEnabled <span class="token operator">=</span> _clipping<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clippingPlanes<span class="token punctuation">,</span> _localClippingEnabled<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 6.WebGLRenderList 的初始化</span>
    currentRenderList <span class="token operator">=</span> renderLists<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentRenderList<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">projectObject</span><span class="token punctuation">(</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>sortObjects <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span><span class="token operator">...</span>

    <span class="token comment">// 7. shadow 的绘制</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> _clippingEnabled <span class="token punctuation">)</span> _clipping<span class="token punctuation">.</span><span class="token function">beginShadows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> shadowsArray <span class="token operator">=</span> currentRenderState<span class="token punctuation">.</span>state<span class="token punctuation">.</span>shadowsArray<span class="token punctuation">;</span>

    shadowMap<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span> shadowsArray<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentRenderState<span class="token punctuation">.</span><span class="token function">setupLights</span><span class="token punctuation">(</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> _clippingEnabled <span class="token punctuation">)</span> _clipping<span class="token punctuation">.</span><span class="token function">endShadows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>info<span class="token punctuation">.</span>autoReset <span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> renderTarget <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        renderTarget <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setRenderTarget</span><span class="token punctuation">(</span> renderTarget <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8.背景的绘制</span>

    background<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span> currentRenderList<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> forceClear <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 9.render scene</span>

    <span class="token keyword">var</span> opaqueObjects <span class="token operator">=</span> currentRenderList<span class="token punctuation">.</span>opaque<span class="token punctuation">;</span>
    <span class="token keyword">var</span> transparentObjects <span class="token operator">=</span> currentRenderList<span class="token punctuation">.</span>transparent<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> scene<span class="token punctuation">.</span>overrideMaterial <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 10.强制使用场景的材质 overrideMaterial 来统一 render 物体。</span>
        <span class="token keyword">var</span> overrideMaterial <span class="token operator">=</span> scene<span class="token punctuation">.</span>overrideMaterial<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> opaqueObjects<span class="token punctuation">.</span>length <span class="token punctuation">)</span> <span class="token function">renderObjects</span><span class="token punctuation">(</span> opaqueObjects<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> overrideMaterial <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> transparentObjects<span class="token punctuation">.</span>length <span class="token punctuation">)</span> <span class="token function">renderObjects</span><span class="token punctuation">(</span> transparentObjects<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> overrideMaterial <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 11.分别对 opaque 和 transparent 的物体进行 render</span>
        <span class="token comment">// opaque pass (front-to-back order)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> opaqueObjects<span class="token punctuation">.</span>length <span class="token punctuation">)</span> <span class="token function">renderObjects</span><span class="token punctuation">(</span> opaqueObjects<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// transparent pass (back-to-front order)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> transparentObjects<span class="token punctuation">.</span>length <span class="token punctuation">)</span> <span class="token function">renderObjects</span><span class="token punctuation">(</span> transparentObjects<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// Generate mipmap if we're using any kind of mipmap filtering</span>
            <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Ensure depth buffer writing is enabled so it can be cleared on next render</span>

    state<span class="token punctuation">.</span>buffers<span class="token punctuation">.</span>depth<span class="token punctuation">.</span><span class="token function">setTest</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>buffers<span class="token punctuation">.</span>depth<span class="token punctuation">.</span><span class="token function">setMask</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>buffers<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">setMask</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    state<span class="token punctuation">.</span><span class="token function">setPolygonOffset</span><span class="token punctuation">(</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    scene<span class="token punctuation">.</span><span class="token function">onAfterRender</span><span class="token punctuation">(</span> _this<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span><span class="token operator">...</span>
    currentRenderList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    currentRenderState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>render() 是渲染的核心，粗略地看它做了大概以下的事情。</p> <ol><li>reset caching for this frame。</li> <li>update scene graph。</li> <li>update camera matrices and frustum。</li> <li>init WebGLRenderState。</li> <li>视景体矩阵计算，为相机的投影矩阵与相机的世界矩阵的逆矩阵的叉乘。</li> <li>WebGLRenderList 的初始化。</li> <li>shadow 的绘制。</li> <li>背景的绘制。</li> <li>render scene。</li> <li>如果overrideMaterial，则强制使用场景的材质 overrideMaterial 来统一 render 物体。</li> <li>分别对 opaque 和 transparent 的物体进行 render。</li></ol> <p>但这里我们不必关注每个处理的细节，仅从几个重要的点着手去理解以及分析。</p> <h4 id="webglrenderlist-的初始化"><a href="#webglrenderlist-的初始化" class="header-anchor">#</a> WebGLRenderList 的初始化</h4> <p>WebGLRenderList 的初始化init()方法本身并没有什么，其只是在 WebGLRenderLists 中通过将 scene.id 和 camera.id 建立起一定的关联。而这里更重要的目的是确定有哪些对象是要被渲染出来的，这个最主要的实现就在 projectObject() 方法中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">projectObject</span><span class="token punctuation">(</span> <span class="token parameter">object<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> sortObjects</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>visible <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> visible <span class="token operator">=</span> object<span class="token punctuation">.</span>layers<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> camera<span class="token punctuation">.</span>layers <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> visible <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否为光照</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isLight <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentRenderState<span class="token punctuation">.</span><span class="token function">pushLight</span><span class="token punctuation">(</span> object <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isSprite <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否为精灵</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> object<span class="token punctuation">.</span>frustumCulled <span class="token operator">||</span> _frustum<span class="token punctuation">.</span><span class="token function">intersectsSprite</span><span class="token punctuation">(</span> object <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token operator">...</span>
        currentRenderList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> object<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> _vector3<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isImmediateRenderObject <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否为立即要渲染的 Object</span>
      <span class="token operator">...</span><span class="token operator">...</span>
      currentRenderList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> object<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span>material<span class="token punctuation">,</span> _vector3<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isMesh <span class="token operator">||</span> object<span class="token punctuation">.</span>isLine <span class="token operator">||</span> object<span class="token punctuation">.</span>isPoints <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否为 mesh,line,points </span>
      <span class="token operator">...</span><span class="token operator">...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> object<span class="token punctuation">.</span>frustumCulled <span class="token operator">||</span> _frustum<span class="token punctuation">.</span><span class="token function">intersectsObject</span><span class="token punctuation">(</span> object <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token operator">...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span> material <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> groups <span class="token operator">=</span> geometry<span class="token punctuation">.</span>groups<span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> groups<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span><span class="token operator">...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> groupMaterial <span class="token operator">&amp;&amp;</span> groupMaterial<span class="token punctuation">.</span>visible <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              currentRenderList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> object<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> groupMaterial<span class="token punctuation">,</span> _vector3<span class="token punctuation">.</span>z<span class="token punctuation">,</span> group <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> material<span class="token punctuation">.</span>visible <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 可见即可渲染</span>
          currentRenderList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> object<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> _vector3<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对每个孩子进行递归遍历</span>
  <span class="token keyword">var</span> children <span class="token operator">=</span> object<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">projectObject</span><span class="token punctuation">(</span> children<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> camera<span class="token punctuation">,</span> sortObjects <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从方法中，我们大致得到如下结论：</p> <p>1、只有可见的光照，精灵，mesh，line，point 会被实际渲染出来。而如果我们只是 new 一个 Object3D 而被指到具体的 3D 对象上，那么理论上它是不会被渲染的。</p> <p>2、光照与其他 Object3D 不一样，它是另外单独被放在 currentRenderState 中的。</p> <p>3、对于整个要渲染的场景图利用递归进行遍历，以确保场景图中的每一个可渲染的 3D object 都可以被渲染出来。这里简单回顾一下，Sence 也是继承自 Object3D 的，而灯光以及可被渲染的 Object 都是作为它的孩子被加入到 Sence 中的。</p> <p>通过 WebGLRenderList 的初始化基本就确定了当前哪些 Object3D 对象是需要渲染的，接下来就是逐个 Object3D 的渲染了。</p> <h4 id="renderobjects"><a href="#renderobjects" class="header-anchor">#</a> renderObjects</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">renderObjects</span><span class="token punctuation">(</span> <span class="token parameter">renderList<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> overrideMaterial</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> renderList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> renderItem <span class="token operator">=</span> renderList<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> camera<span class="token punctuation">.</span>isArrayCamera <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _currentArrayCamera <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token function">renderObject</span><span class="token punctuation">(</span> object<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> group <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>renderObjects 就是遍历所有的 Object3D 对象，然后调用 renderObject() 方法进行进一步渲染。看来脏活都交给了 renderObject()。</p> <h4 id="renderobject"><a href="#renderobject" class="header-anchor">#</a> renderObject</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">renderObject</span><span class="token punctuation">(</span> <span class="token parameter">object<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> group</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 计算 mode view matrix 以及 normal matrix</span>
  object<span class="token punctuation">.</span>modelViewMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span> object<span class="token punctuation">.</span>matrixWorld <span class="token punctuation">)</span><span class="token punctuation">;</span>
  object<span class="token punctuation">.</span>normalMatrix<span class="token punctuation">.</span><span class="token function">getNormalMatrix</span><span class="token punctuation">(</span> object<span class="token punctuation">.</span>modelViewMatrix <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isImmediateRenderObject <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _this<span class="token punctuation">.</span><span class="token function">renderBufferDirect</span><span class="token punctuation">(</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">.</span>fog<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> object<span class="token punctuation">,</span> group <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关于计算 mode view matrix 以及 normal matrix，这里我也不太看明白，所以我选择先跳过。先分析后面的步骤。这里不管是否 isImmediateRenderObject 其流程上差不太多，所以这里先分析 renderBufferDirect()。</p> <h4 id="renderbufferdirect-方法"><a href="#renderbufferdirect-方法" class="header-anchor">#</a> renderBufferDirect()方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">renderBufferDirect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">camera<span class="token punctuation">,</span> fog<span class="token punctuation">,</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> object<span class="token punctuation">,</span> group</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 1.通过WebGLState设置材质的一些属性</span>
  state<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span> material<span class="token punctuation">,</span> frontFaceCW <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.设置 program</span>
  <span class="token keyword">var</span> program <span class="token operator">=</span> <span class="token function">setProgram</span><span class="token punctuation">(</span> camera<span class="token punctuation">,</span> fog<span class="token punctuation">,</span> material<span class="token punctuation">,</span> object <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> updateBuffers <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 3.设置顶点属性</span>
    <span class="token function">setupVertexAttributes</span><span class="token punctuation">(</span> material<span class="token punctuation">,</span> program<span class="token punctuation">,</span> geometry <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4.绑定 buffer</span>
      _gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>buffer <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 5.根据不同网格类型确定相应的绘制模式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isMesh <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> material<span class="token punctuation">.</span>wireframe <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token operator">...</span>
      renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">LINES</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>drawMode <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token literal-property property">TrianglesDrawMode</span><span class="token operator">:</span>
          renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token literal-property property">TriangleStripDrawMode</span><span class="token operator">:</span>
          renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token literal-property property">TriangleFanDrawMode</span><span class="token operator">:</span>
          renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_FAN</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isLine <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isLineSegments <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">LINES</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isLineLoop <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">LINE_LOOP</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">LINE_STRIP</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isPoints <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">POINTS</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> object<span class="token punctuation">.</span>isSprite <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderer<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> geometry <span class="token operator">&amp;&amp;</span> geometry<span class="token punctuation">.</span>isInstancedBufferGeometry <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> geometry<span class="token punctuation">.</span>maxInstancedCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderer<span class="token punctuation">.</span><span class="token function">renderInstances</span><span class="token punctuation">(</span> geometry<span class="token punctuation">,</span> drawStart<span class="token punctuation">,</span> drawCount <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 6.调用 WebGLBufferRenderer#render() 方法进行渲染</span>
    renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span> drawStart<span class="token punctuation">,</span> drawCount <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>renderBufferDirect()方法是一个比较重要的方法，在这里可以看到一个物体被渲染的“最小完整流程”。</p> <p>1、通过WebGLState设置材质的一些属性。这个比较形象，因为整个 OpenGL / ES 它就是一个状态机。这里所设置的材质属性也是直接调用底层的 gl_xxx() 之类的方法。而这里实际就是设置了如 CULL_FACE，depthTest，depthWrite，colorWrite 等等。</p> <p>2、设置 program。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setProgram</span><span class="token punctuation">(</span> <span class="token parameter">camera<span class="token punctuation">,</span> fog<span class="token punctuation">,</span> material<span class="token punctuation">,</span> object</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">var</span> materialProperties <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> material <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lights <span class="token operator">=</span> currentRenderState<span class="token punctuation">.</span>state<span class="token punctuation">.</span>lights<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> material<span class="token punctuation">.</span>needsUpdate <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initMaterial</span><span class="token punctuation">(</span> material<span class="token punctuation">,</span> fog<span class="token punctuation">,</span> object <span class="token punctuation">)</span><span class="token punctuation">;</span>
    material<span class="token punctuation">.</span>needsUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 这里的 program 即 WebGLProgram，也就是我们在流程图中所说的创建程序</span>
  <span class="token keyword">var</span> program <span class="token operator">=</span> materialProperties<span class="token punctuation">.</span>program<span class="token punctuation">,</span>
    p_uniforms <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token function">getUniforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    m_uniforms <span class="token operator">=</span> materialProperties<span class="token punctuation">.</span>shader<span class="token punctuation">.</span>uniforms<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> state<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span> program<span class="token punctuation">.</span>program <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    refreshProgram <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    refreshMaterial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    refreshLights <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  p_uniforms<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> <span class="token string">'modelViewMatrix'</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span>modelViewMatrix <span class="token punctuation">)</span><span class="token punctuation">;</span>
  p_uniforms<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> <span class="token string">'normalMatrix'</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span>normalMatrix <span class="token punctuation">)</span><span class="token punctuation">;</span>
  p_uniforms<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span> _gl<span class="token punctuation">,</span> <span class="token string">'modelMatrix'</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span>matrixWorld <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> program<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法本身是很长的，这里省略了一万字....
我们再来看看其主要所做的事情，这里的 program 就是 WebGLProgram。而想知道 program 具体是什么，这里就涉及到了 WebGLProgram 的初始化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">WebGLProgram</span><span class="token punctuation">(</span> <span class="token parameter">renderer<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> code<span class="token punctuation">,</span> material<span class="token punctuation">,</span> shader<span class="token punctuation">,</span> parameters<span class="token punctuation">,</span> capabilities</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> gl <span class="token operator">=</span> renderer<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> defines <span class="token operator">=</span> material<span class="token punctuation">.</span>defines<span class="token punctuation">;</span>
  <span class="token comment">// 获取顶点 shader 以及片元 shader</span>
  <span class="token keyword">var</span> vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">;</span>
  <span class="token keyword">var</span> fragmentShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>fragmentShader<span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 创建 program </span>
  <span class="token keyword">var</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 构造最终用于进行渲染的 glsl，并且调用 WebGLShader 构造出 shader</span>
  <span class="token keyword">var</span> vertexGlsl <span class="token operator">=</span> prefixVertex <span class="token operator">+</span> vertexShader<span class="token punctuation">;</span>
  <span class="token keyword">var</span> fragmentGlsl <span class="token operator">=</span> prefixFragment <span class="token operator">+</span> fragmentShader<span class="token punctuation">;</span>
  <span class="token comment">// console.log( '*VERTEX*', vertexGlsl );</span>
  <span class="token comment">// console.log( '*FRAGMENT*', fragmentGlsl );</span>
  <span class="token keyword">var</span> glVertexShader <span class="token operator">=</span> <span class="token function">WebGLShader</span><span class="token punctuation">(</span> gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vertexGlsl <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> glFragmentShader <span class="token operator">=</span> <span class="token function">WebGLShader</span><span class="token punctuation">(</span> gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fragmentGlsl <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将 program 关联 shader</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span> program<span class="token punctuation">,</span> glVertexShader <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span> program<span class="token punctuation">,</span> glFragmentShader <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 链接 program</span>
  gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span> program <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>program 的初始化方法也是非常多的，这里简化出关键部分。再回忆一下前面的流程图，就会明白这里主要就是创建 program、shader ，关联 program 和 shader，以及链接程序。链接好了程序之后接下来就可以通过 useProgram() 使用 program 了，这一步骤在 setProgram() 中创建好 program 就调用了。</p> <p>3、设置顶点属性，就是将我们在外面所构造的 geometry 的顶点送到 shader 中去。
4、绑定 buffer。
5、根据不同网格类型确定相应的绘制模式，如以 LINES 进行绘制，以TRIANGLES 进行绘制。
6、调用 WebGLBufferRenderer#render() 方法进行渲染。如下，就是进行最后的 drawArrays() 调用，将上层创建的 geometry 以及 material(组合起来就叫做 mesh) 渲染到 3D 场景的 canvas 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span> <span class="token parameter">start<span class="token punctuation">,</span> count</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span> mode<span class="token punctuation">,</span> start<span class="token punctuation">,</span> count <span class="token punctuation">)</span><span class="token punctuation">;</span>
  info<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> count<span class="token punctuation">,</span> mode <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="图形绘制基础"><a href="#图形绘制基础" class="header-anchor">#</a> 图形绘制基础</h2> <p>WebGL 本质上也是在 canvas 上作画，只不过它基于是一个 3D 的场景。而在 ThreeJs 中，提供了一套 Shape 和 Curve 相关的 API 来帮助我们在 3D 场景中绘制出我们想要的图形。</p> <h3 id="图形绘制主要流程"><a href="#图形绘制主要流程" class="header-anchor">#</a> 图形绘制主要流程</h3> <p>图形绘制一般流程为：构造 Shape、构造 BufferGeometry 、构造 Mesh 并添加到场景中。</p> <h4 id="构造-shape"><a href="#构造-shape" class="header-anchor">#</a> 构造 Shape</h4> <p>在构造 Shape 之前，我们先来了解一下 ThreeJs 中的图形绘制基础。</p> <p>图形绘制的基础有 3 个比较核心的类：Curve，Path 以及 Shape。如下是用于进行图形绘制的一个比较全局的类图。</p> <p><img src="/web-bookmarks/assets/img/three-draw-img.3b6a02a7.jpg" alt=""></p> <p>在实际的开发过程中，我们一般使用 Shape 来绘制出我们想要的形状，和 canvas 一样，也可以绘制出矩形、三角形、直线、圆弧等，甚至可以一并绘制出更复杂的图形，如鱼形、剪刀等。</p> <p>而在上图中，Shape 继承自 Path，Path 又间接继承自 Curve，Path 封装了各种绘制图形的 API 接口，如 ：</p> <ul><li>lineTo: 绘制直线</li> <li>quadraticCurveTo: 二次贝塞尔曲线</li> <li>bezierCurveTo: 三次贝塞尔曲线</li> <li>arc: 弧线</li> <li>ellipse: 椭圆</li></ul> <p>在 Path 的各种绘制 API 中，又是进一步构造相应的曲线，如 new 一个 LineCurve，CubicBezierCurve 等，从而完成曲线的构造。</p> <p>有了这些图形绘制的 API，在 3D 场景中，利用这些 API 不仅可以绘制 2D 的图形，还可以绘制 3D 的图形。上面类图中，<code>***Curve</code> 带后缀 3 的都是进行 3D 的图形绘制，其他自然就都是 2D 的绘制了。</p> <p>如下，我们利用 Bezier 来构造一个圆。关于如何用 Bezier 来构造圆，就不在这里展开了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> circleRadius <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> circleShape <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
circleShape<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> circleRadius <span class="token punctuation">)</span><span class="token punctuation">;</span>

circleShape<span class="token punctuation">.</span><span class="token function">quadraticCurveTo</span><span class="token punctuation">(</span> circleRadius<span class="token punctuation">,</span> circleRadius<span class="token punctuation">,</span> circleRadius<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
circleShape<span class="token punctuation">.</span><span class="token function">quadraticCurveTo</span><span class="token punctuation">(</span> circleRadius<span class="token punctuation">,</span> <span class="token operator">-</span> circleRadius<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span> circleRadius <span class="token punctuation">)</span><span class="token punctuation">;</span>
circleShape<span class="token punctuation">.</span><span class="token function">quadraticCurveTo</span><span class="token punctuation">(</span> <span class="token operator">-</span> circleRadius<span class="token punctuation">,</span> <span class="token operator">-</span> circleRadius<span class="token punctuation">,</span> <span class="token operator">-</span> circleRadius<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
circleShape<span class="token punctuation">.</span><span class="token function">quadraticCurveTo</span><span class="token punctuation">(</span> <span class="token operator">-</span> circleRadius<span class="token punctuation">,</span> circleRadius<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> circleRadius <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="构造-buffergeometry"><a href="#构造-buffergeometry" class="header-anchor">#</a> 构造 BufferGeometry</h4> <p>上面通过 Shape 构造出了我们想要的图形，下一步我们需要获取图形的所有点，并从这些点构造 BufferGeometry。</p> <p>Shape 是间接继承自 Curve ，Curve 定义了 getPoints() 的基础。Shape 的 getPoints() 的具体实现在 CurvePath 中的实现，从而获取构造这个图形所需要的点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> points <span class="token operator">=</span> shape<span class="token punctuation">.</span><span class="token function">getPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> geometryPoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>BufferGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromPoints</span><span class="token punctuation">(</span> subPoints <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="构造网格"><a href="#构造网格" class="header-anchor">#</a> 构造网格</h4> <p>拿到 BufferGeometry 就可以构造出我们要的物体了。这里为了效果上表达明显一点，并且炫酷一点，就用 Line 逐段逐段绘制出了我们前面所构造的圆。</p> <p>实现代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addLineShape</span><span class="token punctuation">(</span> <span class="token parameter">shape<span class="token punctuation">,</span> color<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> rx<span class="token punctuation">,</span> ry<span class="token punctuation">,</span> rz<span class="token punctuation">,</span> s</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// lines</span>
  shape<span class="token punctuation">.</span>autoClose <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> points <span class="token operator">=</span> shape<span class="token punctuation">.</span><span class="token function">getPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;addLineShape &quot;</span><span class="token punctuation">,</span> points <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> points<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">drawLine</span><span class="token punctuation">(</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">==</span> length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> subPoints1 <span class="token operator">=</span> points<span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> subPoints2 <span class="token operator">=</span> points<span class="token punctuation">[</span><span class="token punctuation">(</span>val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> length<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> subPoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    subPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subPoints1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    subPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subPoints2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> geometryPoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>BufferGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromPoints</span><span class="token punctuation">(</span> subPoints <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// solid line</span>

    <span class="token keyword">var</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Line</span><span class="token punctuation">(</span> geometryPoints<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>LineBasicMaterial</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> color <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    line<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">)</span><span class="token punctuation">;</span>
    line<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> rx<span class="token punctuation">,</span> ry<span class="token punctuation">,</span> rz <span class="token punctuation">)</span><span class="token punctuation">;</span>
    line<span class="token punctuation">.</span>scale<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> s<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token punctuation">)</span><span class="token punctuation">;</span>
    scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> line <span class="token punctuation">)</span><span class="token punctuation">;</span>

    val<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span>drawLine<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="光和影"><a href="#光和影" class="header-anchor">#</a> 光和影</h2> <p>光的基类是 Light，其是继承自 Object3D 的。它作为一个对象被添加进了 Scene 中，从而进行渲染的。影的基类是 LightShadow，它是作为光的内部类，供光照在内部进行阴影计算的，我们不能直接构造它。如图，并不是所有的光照都会产生阴影，是否会产生阴影与光照所具备的特性有关。
<img src="/web-bookmarks/assets/img/three-light.234b87c7.jpg" alt=""></p> <h3 id="light"><a href="#light" class="header-anchor">#</a> Light</h3> <p><img src="data:image/jpeg;base64,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" alt=""></p> <h3 id="ambientlight"><a href="#ambientlight" class="header-anchor">#</a> AmbientLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-2.b30b31f5.jpg" alt=""></p> <h3 id="directionallight"><a href="#directionallight" class="header-anchor">#</a> DirectionalLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-3.244b4d24.jpg" alt=""></p> <h3 id="hemispherelight"><a href="#hemispherelight" class="header-anchor">#</a> HemisphereLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-4.7dc4b683.jpg" alt=""></p> <h3 id="pointlight"><a href="#pointlight" class="header-anchor">#</a> PointLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-5.f621c9b6.jpg" alt=""></p> <h3 id="rectarealight"><a href="#rectarealight" class="header-anchor">#</a> RectAreaLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-6.e33c6c7e.jpg" alt=""></p> <h3 id="spotlight"><a href="#spotlight" class="header-anchor">#</a> SpotLight</h3> <p><img src="/web-bookmarks/assets/img/three-light-7.b8268430.jpg" alt=""></p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p><img src="/web-bookmarks/assets/img/three-light-8.212d87a2.jpg" alt=""></p> <h2 id="纹理"><a href="#纹理" class="header-anchor">#</a> 纹理</h2> <p>渲染一个 3D 物体时，网格 Mesh 决定了这个物体的形状态，如一个球，一辆车，一个人等。而纹理决定了这个物体的表面具体长什么样子。一个球包上一层篮球的花纹就是篮球了，而如果包上的是一层足球的花纹那可能就是足球了。</p> <p><img src="/web-bookmarks/assets/img/three-texture.760be404.jpg" alt=""></p> <p>纹理的基类是 Texture，一般我们都使用这个类，通过给其属性 Image 传入一个图片从而构造出一个纹理。纹理是材质的属性，材质和几何体 Gemotry 构成 Mesh ，然后被添加到 Scene 中进行渲染。纹理决定了物体的表面该是什么样子，而材质则决定了物体具备什么样的“气质”。后面还会再专门学习材质，下面再详细地看一看各个纹理的作用及其使用场景。</p> <h3 id="canvastexture"><a href="#canvastexture" class="header-anchor">#</a> CanvasTexture</h3> <p>CanvasTexture 主要是用于将 Dom 元素 <code>&lt;canvas&gt;</code> 中绘制的内容，以纹理的方式贴到模型上。在 canvas 中我们可以绘制任何我们想要绘制的图形或者文字。以下代码就是在 Canvas 中绘制文本，从而创建一个 CanvasTexture。</p> <h3 id="compressedtexture"><a href="#compressedtexture" class="header-anchor">#</a> CompressedTexture</h3> <p>压缩的纹理，基于被压缩的数据，创建一个纹理贴图，例如从一个DDS文件中</p> <h3 id="cubetexture"><a href="#cubetexture" class="header-anchor">#</a> CubeTexture</h3> <p>立方纹理，创建一个由6张图片所组成的纹理对象</p> <p>特性：一般用于环境贴图，一般由 CubeTextureLoader 来创建，创建时传入一个包括6张独立图片的数组</p> <h3 id="datatexture"><a href="#datatexture" class="header-anchor">#</a> DataTexture</h3> <p>数据纹理，直接从原始数据，宽度和高度创建纹理</p> <p>属性：data，用于构造纹理的数据，其类型必须是ArrayBufferView</p> <h3 id="datatexture3d"><a href="#datatexture3d" class="header-anchor">#</a> DataTexture3D</h3> <p>创建一个三维的纹理贴图，这种纹理贴图只能被用于webgl2 渲染环境中</p> <h3 id="depthtexture"><a href="#depthtexture" class="header-anchor">#</a> DepthTexture</h3> <p>创建一个作为深度纹理贴图来使用的纹理，需要支持WEBGL_depth_texture扩展。</p> <p>对于深度纹理贴图，这里首先要弄明白什么是深度图。深度图像包含了普通的RGB三通道彩色图像和Depth Map。而通俗的讲，深度就是每个像素距离当时相机所在位置的距离。</p> <h3 id="videotexture"><a href="#videotexture" class="header-anchor">#</a> VideoTexture</h3> <p>创建一个使用视频来作为贴图的纹理对象</p> <h2 id="材质"><a href="#材质" class="header-anchor">#</a> 材质</h2> <p>材质和纹理有那么一点微妙的关系，纹理决定了物体的表面，而材质则决定了物体的“气质”，比如说，反射度，光滑度，金属感，塑料感或者玻璃的模仿等。当然，在 ThreeJs 中，纹理想要被展示出来是要被依附在材质中的。</p> <p><img src="/web-bookmarks/assets/img/three-material.bd28ac9f.jpg" alt=""></p> <p><a href="https://www.jianshu.com/p/f708c0930edd" target="_blank" rel="noopener noreferrer">所有纹理全介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="场景和雾"><a href="#场景和雾" class="header-anchor">#</a> 场景和雾</h2> <p><a href="https://www.jianshu.com/p/c89b0c8d4123" target="_blank" rel="noopener noreferrer">ThreeJs 认识场景和雾<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="相机"><a href="#相机" class="header-anchor">#</a> 相机</h2> <p><a href="https://www.jianshu.com/p/6c5a69d5cbc1" target="_blank" rel="noopener noreferrer">ThreeJs 认识相机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="核心类"><a href="#核心类" class="header-anchor">#</a> 核心类</h2> <p><a href="https://www.jianshu.com/p/389a9d0651be" target="_blank" rel="noopener noreferrer">ThreeJs 认识核心类<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="补充"><a href="#补充" class="header-anchor">#</a> 补充</h2> <p><a href="https://www.jianshu.com/p/122bd50bc42b" target="_blank" rel="noopener noreferrer">基于 Canvas 手撸一个六边形能力图<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Neveryu/web-bookmarks/edit/master/summary/notes/three-first.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/10/2025, 2:54:02 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web-bookmarks/summary/notes/sass1.html" class="prev">
        sass、Compass 安装使用
      </a></span> <span class="next"><a href="/web-bookmarks/summary/notes/three1.html">
        Three.js开发指南（第3版）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/web-bookmarks/assets/js/app.043910a3.js" defer></script><script src="/web-bookmarks/assets/js/2.74e402c0.js" defer></script><script src="/web-bookmarks/assets/js/1.f201e22a.js" defer></script><script src="/web-bookmarks/assets/js/11.a8e47de5.js" defer></script>
  </body>
</html>
